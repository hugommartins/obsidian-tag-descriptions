"use strict";var b=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var S=Object.getOwnPropertyNames;var A=Object.prototype.hasOwnProperty;var $=(c,s)=>{for(var t in s)b(c,t,{get:s[t],enumerable:!0})},H=(c,s,t,e)=>{if(s&&typeof s=="object"||typeof s=="function")for(let i of S(s))!A.call(c,i)&&i!==t&&b(c,i,{get:()=>s[i],enumerable:!(e=k(s,i))||e.enumerable});return c};var I=c=>H(b({},"__esModule",{value:!0}),c);var B={};$(B,{default:()=>w});module.exports=I(B);var h=require("obsidian");var C={tagMap:{},confirmDelete:!0};var L=[".tag",".cm-hashtag",".cm-hashtag-begin",".cm-hashtag-end",".metadata-property-tag",".multi-select-pill-content"].join(", "),p=100;var l=require("obsidian");var u=require("obsidian");var T=class extends u.Modal{constructor(t,e,i,n){super(t);this.plugin=e;this.tag=i;this.onConfirm=n}onOpen(){let{contentEl:t,titleEl:e}=this;e.setText("Delete tag description"),t.addClass("tag-delete-modal"),t.createEl("p",{text:`Are you sure you want to remove the description for ${this.tag}?`});let i=t.createDiv({cls:"modal-button-container"});i.createEl("button",{text:"Cancel"}).onclick=()=>this.close();let n=i.createEl("button",{text:"Delete",cls:"mod-warning"});n.onclick=()=>{this.onConfirm(),this.close()}}},v=class extends u.Modal{constructor(t,e,i,n){super(t);this.tag=e;this.value=i;this.onSave=n}onOpen(){let{contentEl:t,titleEl:e}=this;t.addClass("tag-tooltip-modal"),e.setText(`Description for ${this.tag}`);let i=new u.Setting(t).addText(a=>{a.setValue(this.value).onChange(m=>{this.value=m,n.setText(`${m.length}/${p}`)}),a.inputEl.maxLength=p}),n=t.createDiv({cls:"tag-modal-counter",text:`${this.value.length}/${p}`}),r=i.controlEl.querySelector("input");r.focus();let g=t.createDiv({cls:"modal-button-container"}),o=async()=>{if(!this.value.trim()){new u.Notice("Description cannot be empty!");return}await this.onSave(this.value.trim()),this.close()};g.createEl("button",{text:"Save",cls:"mod-cta"}).onclick=()=>{o()},r.addEventListener("keydown",a=>{a.key==="Enter"&&(a.preventDefault(),o())})}};var y=class extends l.PluginSettingTab{constructor(t,e){super(t,e);this.plugin=e}searchQuery="";editingTag=null;display(){let{containerEl:t}=this;t.empty(),this.renderAddForm(t),this.renderBackup(t),this.renderPreferences(t),this.renderLibrary(t)}renderAddForm(t){let e=new l.Setting(t).setName("Add new tooltip").setDesc("Assign a meaning to a tag.");e.settingEl.addClass("tag-tooltip-add-row");let i="",n="",r=async()=>{let o=this.plugin.formatTag(i.trim()),a=n.trim();if(!o||o.length<2){new l.Notice("Invalid tag");return}if(!a){new l.Notice("Description cannot be empty");return}if(this.plugin.settings.tagMap[o]){new l.Notice(`${o} already exists`);return}this.plugin.settings.tagMap[o]=a,await this.plugin.saveSettings(),this.display(),new l.Notice(`Added ${o}`)};e.addText(o=>{o.setPlaceholder("#tag").onChange(a=>i=a),o.inputEl.addEventListener("keydown",a=>{a.key==="Enter"&&r()})}).addText(o=>{o.setPlaceholder("Description...").onChange(a=>{n=a,g.setText(`${a.length}/${p}`)}),o.inputEl.maxLength=p,o.inputEl.addEventListener("keydown",a=>{a.key==="Enter"&&r()})});let g=e.controlEl.createDiv({cls:"tag-char-counter",text:`0/${p}`});e.addButton(o=>{o.setButtonText("Add").setCta().onClick(()=>{r()})})}renderBackup(t){new l.Setting(t).setName("Backup & restore").setDesc("Export or import tag descriptions.").addButton(e=>e.setButtonText("Export").onClick(()=>void this.exportLibrary())).addButton(e=>e.setButtonText("Import").onClick(()=>void this.importLibrary()))}renderPreferences(t){new l.Setting(t).setName("Confirm before deleting").setDesc("Show a confirmation popup before removing a description.").addToggle(e=>e.setValue(this.plugin.settings.confirmDelete).onChange(async i=>{this.plugin.settings.confirmDelete=i,await this.plugin.saveSettings()}))}renderLibrary(t){if(!Object.entries(this.plugin.settings.tagMap).length)return;let i=t.createDiv({cls:"setting-group"}),n=i.createDiv({cls:"setting-item setting-item-heading"});n.createDiv({cls:"setting-item-name",text:"Library"});let r=n.createDiv({cls:"setting-item-control"}),g=i.createDiv({cls:"setting-items"});new l.Setting(r).addSearch(o=>{o.setPlaceholder("Filter tags...").setValue(this.searchQuery).onChange((0,l.debounce)(a=>{this.searchQuery=a.toLowerCase(),this.renderList(g)},250,!0))}),this.renderList(g)}renderList(t){t.empty();let e=Object.entries(this.plugin.settings.tagMap).filter(([i,n])=>i.toLowerCase().includes(this.searchQuery)||n.toLowerCase().includes(this.searchQuery));if(!e.length){t.createDiv({cls:"tag-tooltip-empty",text:"No matching tags"});return}e.forEach(([i,n])=>this.editingTag===i?this.renderEditRow(t,i,n):this.renderDisplayRow(t,i,n))}renderDisplayRow(t,e,i){let n=new l.Setting(t);n.settingEl.addClass("tag-library-item"),n.setName(e).setDesc(i),n.addExtraButton(r=>r.setIcon("pencil").onClick(()=>{this.editingTag=e,this.display()})),n.addExtraButton(r=>r.setIcon("trash-2").onClick(()=>this.deleteTag(e)))}renderEditRow(t,e,i){let n=new l.Setting(t);n.settingEl.addClass("tag-library-item"),n.infoEl.remove();let r=n.controlEl.createDiv({cls:"tag-tooltip-input-wrapper tag-tooltip-edit-mode"}),g=r.createEl("input",{cls:"tag-edit-input",value:e}),o=r.createEl("textarea",{cls:"tag-edit-textarea",attr:{rows:"1"}});o.value=i,o.maxLength=p;let a=r.createDiv({cls:"tag-char-counter",text:`${i.length}/${p}`});o.addEventListener("input",()=>{a.setText(`${o.value.length}/${p}`)}),setTimeout(()=>{o.setAttribute("style",`height: auto; height: ${o.scrollHeight}px;`),o.focus()},0);let m=async()=>{let d=this.plugin.formatTag(g.value.trim()),E=o.value.trim();if(!E){new l.Notice("Description cannot be empty!");return}if(d!==e&&this.plugin.settings.tagMap[d]){new l.Notice("Tag already exists.");return}let f={};for(let x of Object.keys(this.plugin.settings.tagMap))x===e?f[d]=E:f[x]=this.plugin.settings.tagMap[x];this.plugin.settings.tagMap=f,await this.plugin.saveSettings(),this.editingTag=null,this.display()};[g,o].forEach(d=>{d.addEventListener("keydown",E=>{E.key==="Enter"&&(E.preventDefault(),m())})}),n.addExtraButton(d=>d.setIcon("check").onClick(()=>{m()})),n.addExtraButton(d=>d.setIcon("x").onClick(()=>{this.editingTag=null,this.display()}))}deleteTag(t){let e=async()=>{delete this.plugin.settings.tagMap[t],await this.plugin.saveSettings(),this.display(),new l.Notice(`${t} deleted.`)};if(!this.plugin.settings.confirmDelete){e();return}new T(this.app,this.plugin,t,()=>{e()}).open()}exportLibrary(){let t=new Blob([JSON.stringify(this.plugin.settings.tagMap,null,2)],{type:"application/json"}),e=URL.createObjectURL(t),i=document.createElement("a");i.href=e,i.download="tag-tooltips-backup.json",i.click(),URL.revokeObjectURL(e)}importLibrary(){let t=document.createElement("input");t.type="file",t.accept=".json",t.onchange=async e=>{let n=e.target.files?.[0];if(n)try{let r=JSON.parse(await n.text());if(typeof r!="object"||Array.isArray(r))throw new Error;Object.assign(this.plugin.settings.tagMap,r),await this.plugin.saveSettings(),this.display(),new l.Notice("Library imported!")}catch{new l.Notice("Invalid JSON file.")}},t.click()}};function D(c=""){let s=c.replace(/#/g,"").trim();return s?`#${s}`:""}function M(c){let s=c.getCursor(),e=c.getClickableTokenAt(s);return e&&e.type==="tag"?e.text:null}var w=class extends h.Plugin{settings;tooltipEl;async onload(){await this.loadSettings(),this.createTooltip(),this.registerHoverEvents(),this.registerContextMenu(),this.addSettingTab(new y(this.app,this))}onunload(){this.tooltipEl?.remove()}createTooltip(){this.tooltipEl=document.body.createEl("div",{cls:"tag-tooltip-container"}),this.hideTooltip()}showTooltip(s,t){this.tooltipEl.setText(t),this.tooltipEl.addClass("is-active");let e=s.getBoundingClientRect(),i=2,n=15,r=e.top-this.tooltipEl.offsetHeight-i;r<0&&(r=e.bottom+i);let g=e.left,o=window.innerWidth-this.tooltipEl.offsetWidth-n;g>o&&(g=o),g<n&&(g=n),Object.assign(this.tooltipEl.style,{top:`${r}px`,left:`${g}px`})}hideTooltip(){this.tooltipEl.removeClass("is-active")}registerHoverEvents(){let s=(0,h.debounce)((t,e)=>{this.showTooltip(t,e)},50,!0);this.registerDomEvent(window.activeDocument,"mouseover",t=>{let i=t.target.closest(L);if(!i){this.hideTooltip();return}let n=this.formatTag(i.textContent??""),r=this.settings.tagMap[n];r&&s(i,r)}),this.registerDomEvent(window.activeDocument,"mouseout",t=>{let e=t.relatedTarget;(!e||!e.closest(L))&&this.hideTooltip()})}formatTag(s){return D(s)}registerContextMenu(){this.registerEvent(this.app.workspace.on("editor-menu",(s,t)=>{let e=this.getTagAtCursor(t);e&&this.addTagMenuItem(s,e)})),this.registerEvent(this.app.workspace.on("tag-menu",(s,t)=>{t&&this.addTagMenuItem(s,t)}))}getTagAtCursor(s){return M(s)}addTagMenuItem(s,t){s.addItem(e=>e.setTitle(`Set description for ${t}`).setIcon("tag").setSection("action-section").onClick(async()=>{new v(this.app,t,this.settings.tagMap[t]??"",async i=>{this.settings.tagMap[t]=i,await this.saveSettings(),new h.Notice(`Tooltip for ${t} saved!`)}).open()}))}async loadSettings(){let s=await this.loadData();this.settings=Object.assign({},C,s)}async saveSettings(){await this.saveData(this.settings)}};
